<!DOCTYPE html>
<html lang="en" id="dnscrypt-proxy">
    <head>
        <title>
            {{.Title}}
        </title>
        <link rel="stylesheet" type="text/css" href="/webman/3rdparty/dnscrypt-proxy/style.css">
    </head>
    <body>
        <div class="message">
            <p class="error">{{.ErrorMessage}}</p>
            <p class="success">{{.SuccessMessage}}</p>
        </div>
        <form method="get" class="fileSelector">
            <span id="fileSelect">
                <select name="file">
                    {{- $File := .File -}}
                    {{- range $key, $value := .Files -}}
                        {{- if eq $File $key }}
                    <option value="{{ $key }}" selected>{{ $value }}</option>
                        {{- else }}
                    <option value="{{ $key }}">{{ $value }}</option>
                        {{- end -}}
                    {{- end }}
                </select>
            </span>
        </form>
        <form method="post" class="updateBlacklist">
            <input class="btn" type="submit" name="generateBlacklist" value="Generate Blacklist">
        </form>
        <form method="post" class="fileEditor">
            <input type="hidden" name="file" value="{{.File}}">
            <div id="fileContent">
                <textarea name="fileContent" autocomplete="off">{{.FileData}}</textarea>
            </div>
            <input class="btn primary" type="submit" value="Save">
        </form>
    </body>
    <script src="codemirror/lib/codemirror.js"></script>
    <link rel="stylesheet" href="codemirror/lib/codemirror.css">
    <script src="codemirror/mode/toml/toml.js"></script>
    <script type="text/javascript">
        textArea = document.getElementsByTagName('textarea')[0]
        if (typeof CodeMirror === "undefined") {
            textArea.style.opacity = 1
        }
        CodeMirror.fromTextArea(textArea, {
            lineNumbers: true
        });
    </script>
    <script type="text/javascript">
        function setGetParameter (key, value) {
            var baseUrl = [location.protocol, '//', location.host, location.pathname].join('')
            var param = '?' + key + '=' + value
            document.location = baseUrl+param
        }

        function ajax (method, data) {
            var request = new XMLHttpRequest()
            request.onload = function() {
                if (request.status >= 200 && request.status < 400) {
                    console.log(request.responseText)
                } else {
                    console.warn(request.status, request.responseText)
                }
                toggleSpinner()
            }
            request.onerror = function() {
                console.warn(request.status, request.responseText)
                toggleSpinner()
            }
            if (method === 'POST') {
                request.open(method, '', true)
                request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
                request.send(data)
            } else {
                request.open(method, data, true);
                request.send()
            }
        }

        function toggleSpinner () {
            // el = document.getElementById("spinner");
            // el.style.visibility = (el.style.visibility === "visible") ? "hidden" : "visible";
        }

        select = document.getElementsByTagName('select')[0]
        select.addEventListener('change', function(e) {
            setGetParameter(e.target.name, e.target.value)
        }, false);

        updateBlacklist = document.querySelectorAll('.updateBlacklist')[0]
        updateBlacklist.addEventListener('submit', function(e) {
            if (e.preventDefault) e.preventDefault();
            toggleSpinner()
            ajax('POST', 'generateBlacklist=true')
        }, false);

    </script>
</html>
